#include <stdint.h>
#include "sun.h"
#include "map.h"
#include "plants.h"
#include "game_timer.h"


extern slot_t lawn_map[32];
uint8_t grid_sun[4][8];
uint8_t rand_sun_present = 0;
int32_t rand_sun_appear_time = 0;
uint16_t rand_sun_target_y = 0;
uint16_t  rand_sun_curr_y = 0;
uint16_t rand_sun_pos_x = 0;

uint8_t sun_img[3600] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xb0,0x0b,
		0x00,0x00,0x00,0x00,0x00,0x00,0xb0,0x0b,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0xb0,0x0b,0x00,0x00,0x00,0x00,0x00,0x00,
		0xb0,0x0b,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0xbb,0xbb,0x00,0x00,0x00,
		0x00,0x00,0x00,0xbb,0x0b,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xbb,0xbb,
		0x00,0x00,0x00,0x00,0x00,0xb0,0xbb,0x0b,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0xbb,0xbb,0x0b,0x00,0x00,0x00,0x00,0xb0,
		0xbb,0x0b,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0xbb,0xbb,0xbb,0x00,0x00,
		0x00,0x00,0xbb,0xbb,0x0b,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xbb,0xbb,
		0xbb,0x0b,0x00,0x00,0xb0,0xbb,0xbb,0x0b,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0xbb,0xbb,0xbb,0x0b,0x00,0x00,0xbb,0xbb,
		0xbb,0x0b,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0xbb,0xbb,0xbb,0x0b,0x00,
		0xb0,0xbb,0xbb,0xbb,0x0b,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0xb0,0x00,0x00,0x00,0x00,0x00,0x00,0xbb,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0x0b,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0xb0,0xbb,0x0b,0x00,0x00,0x00,
		0x00,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0x0b,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xbb,0xbb,
		0x0b,0x00,0x00,0x00,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0xbb,0xbb,0x0b,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0xbb,0xbb,0xbb,0xbb,0x00,0xb0,0xbb,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0x00,
		0x00,0xb0,0xbb,0xbb,0xbb,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0xb0,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0x00,0xb0,0xbb,0xbb,0xbb,0x0b,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xb0,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0xbb,0x0b,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0xb0,0xbb,0xbb,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0x0b,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xb0,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0x44,0x44,
		0x44,0xb4,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0xb0,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0x44,0x55,0x55,0x55,0x45,0xb4,0xbb,0xbb,0xbb,
		0xbb,0xbb,0x0b,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0xbb,0xbb,0xbb,
		0xbb,0xbb,0x4b,0x54,0x55,0x55,0x55,0x55,0x44,
		0xbb,0xbb,0xbb,0xbb,0xbb,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0xb0,0xbb,0xbb,0xbb,0xbb,0x44,0x55,0x55,0x55,
		0x55,0x55,0x45,0xb4,0xbb,0xbb,0xbb,0xbb,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0xbb,0xbb,0xbb,0xbb,0x4b,0x54,
		0x55,0x55,0x55,0x55,0x55,0x55,0x44,0xbb,0xbb,
		0xbb,0xbb,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0x4b,0x55,0x55,0x55,0x55,0x55,0x55,0x55,
		0x45,0xb4,0xbb,0xbb,0xbb,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0xb0,0xbb,0xbb,
		0xbb,0xbb,0xbb,0xbb,0x54,0x55,0x55,0x55,0x55,
		0x55,0x55,0x55,0x55,0xb4,0xbb,0xbb,0xbb,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0x54,0x55,
		0x55,0x55,0x55,0x55,0x55,0x55,0x55,0xb4,0xbb,
		0xbb,0xbb,0xbb,0x00,0x00,0x00,0x00,0x00,0x00,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0x54,0x55,0x55,0x55,0x55,0x55,0x55,0x55,
		0x55,0xb4,0xbb,0xbb,0xbb,0xbb,0xbb,0x00,0x00,
		0x00,0x00,0x00,0x00,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0xbb,0xbb,0x54,0x55,0x55,0x55,0x55,
		0x55,0x55,0x55,0x55,0xb4,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0x00,0x00,0x00,0x00,0x00,0x00,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0x54,0x55,
		0x55,0x55,0x55,0x55,0x55,0x55,0x55,0xb4,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0x00,0x00,0x00,
		0x00,0x00,0x00,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0x54,0x55,0x55,0x55,0x55,0x55,0x55,0x55,
		0x55,0xb4,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0x0b,0x00,0x00,0x00,0x00,0x00,0xbb,0xbb,
		0xbb,0xbb,0xbb,0xbb,0x54,0x55,0x55,0x55,0x55,
		0x55,0x55,0x55,0x55,0xb4,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0xbb,0x0b,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0xbb,0xbb,0xbb,0xbb,0xbb,0x4b,0x55,
		0x55,0x55,0x55,0x55,0x55,0x55,0x45,0xb4,0xbb,
		0xbb,0xbb,0xbb,0xbb,0x0b,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0xbb,0xbb,0xbb,
		0xbb,0x4b,0x54,0x55,0x55,0x55,0x55,0x55,0x55,
		0x44,0xbb,0xbb,0xbb,0xbb,0x0b,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xb0,
		0xbb,0xbb,0xbb,0xbb,0xbb,0x44,0x55,0x55,0x55,
		0x55,0x55,0x45,0xb4,0xbb,0xbb,0xbb,0xbb,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0xb0,0xbb,0xbb,0xbb,0xbb,0xbb,0x4b,
		0x55,0x55,0x55,0x55,0x55,0x45,0xbb,0xbb,0xbb,
		0xbb,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0xbb,0x44,0x55,0x55,0x55,0x45,0xb4,
		0xbb,0xbb,0xbb,0xbb,0x0b,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xb0,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0x4b,0x44,0x44,
		0x44,0x44,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0x0b,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0xb0,0xbb,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0x0b,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0xbb,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0xb0,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0xb0,0xbb,0xbb,0x00,
		0x00,0x00,0x00,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0x0b,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0xbb,0xbb,0xbb,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0x0b,0x00,0x00,
		0xbb,0xbb,0xbb,0x0b,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0x0b,0x00,0x00,0x00,0xbb,0xbb,0xbb,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,
		0xbb,0xbb,0xbb,0x0b,0x00,0x00,0x00,0x00,0x00,
		0xb0,0x0b,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0xbb,0xbb,0xbb,
		0xbb,0x00,0xb0,0xbb,0xbb,0xbb,0x0b,0x00,0x00,
		0x00,0x00,0x00,0x00,0x0b,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0xbb,0xbb,0xbb,0x0b,0x00,0x00,0xbb,0xbb,0xbb,
		0x0b,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0xbb,0xbb,0xbb,0x00,0x00,0x00,
		0xbb,0xbb,0xbb,0x0b,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0xbb,0xbb,0xbb,
		0x00,0x00,0x00,0xb0,0xbb,0xbb,0x0b,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0xbb,0xbb,0x00,0x00,0x00,0x00,0xb0,0xbb,0xbb,
		0x0b,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0xbb,0x0b,0x00,0x00,0x00,0x00,
		0x00,0xb0,0xbb,0x0b,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0xbb,0x00,0x00,
		0x00,0x00,0x00,0x00,0xb0,0xbb,0x0b,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0xbb,0x00,0x00,0x00,0x00,0x00,0x00,0xb0,0xbb,
		0x0b,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0xbb,0x0b,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		};

void init_grid_sun(void){
	for(uint8_t i = 0; i < 4; i++){
		for(uint8_t j = 0; j < 8; j++){
			grid_sun[i][j] = 0;
		}
	}
}

void draw_sun(uint16_t x, uint16_t y, BRAM_t* hdmi_ctrl){
	for(int i = 0; i < SUN_HEIGHT; i++){
		for(int j = 0; j < SUN_WIDTH/2; j++){
			uint8_t pixel = sun_img[i*SUN_WIDTH/2+j];
			if(pixel != 0) hdmi_ctrl->VRAM[320*(i+y)+j+x/2] = pixel;
		}
	}
}

void clear_sun(uint16_t x, uint16_t y, BRAM_t* hdmi_ctrl){
	for(int i = 0; i < SUN_HEIGHT; i++){
		for(int j = 0; j < SUN_WIDTH/2; j++){
			uint8_t pixel = sun_img[i*SUN_WIDTH/2+j];
			if(pixel != 0) hdmi_ctrl->VRAM[320*(i+y)+j+x/2] = 0;
		}
	}
}

void generate_grid_sun(void){
	uint32_t cur_time =  game_get_time_ms();
	for(uint8_t i = 0; i < 32; i++){
		if(lawn_map[i].plant_type == SUN_FLOWER &&
		(cur_time - lawn_map[i].last_action_time > 20000)){  // TODO: modify this value
			grid_sun[i / 8][i % 8] = 1;
			lawn_map[i].last_action_time = cur_time;
		}
	}
}

void draw_all_grid_sun(BRAM_t* hdmi_ctrl){
	for(uint8_t i = 0; i < 4; i++){
		for(uint8_t j = 0; j < 8; j++){
			if(grid_sun[i][j]){
				draw_sun(j*SLOT_WIDTH+SUN_OFFSET_X,i*SLOT_HEIGHT+SUN_OFFSET_Y,hdmi_ctrl);
			}
		}
	}
}

void pick_sun(uint16_t x, uint16_t y,BRAM_t* hdmi_ctrl){
	if(rand_sun_present){
		if((int)x - (int)rand_sun_pos_x>0 && (int)x - (int)rand_sun_pos_x < SUN_WIDTH
				&& (int)y - (int)rand_sun_curr_y > 0 && (int)y - (int)rand_sun_curr_y < SUN_HEIGHT){
			rand_sun_present = 0;
			clear_sun(rand_sun_pos_x, rand_sun_curr_y, hdmi_ctrl);
			increase_sun(1);
		}
	}

	if(x < SUN_OFFSET_X) x = 0; else x -= SUN_OFFSET_X;
	if(y < SUN_OFFSET_Y) y = 0; else y -= SUN_OFFSET_Y;
	x = x / SLOT_WIDTH;
	y = y / SLOT_HEIGHT;
	if(x > 7) x = 7;
	if(y > 3) y = 3;
	if(grid_sun[y][x]){
		clear_sun(x*SLOT_WIDTH+SUN_OFFSET_X,y*SLOT_HEIGHT+SUN_OFFSET_Y,hdmi_ctrl);
		grid_sun[y][x] = 0;
		increase_sun(1);
	}

}

void generate_rand_sun(void){
	if(rand_sun_present) return;
	rand_sun_present = 1;
	rand_sun_pos_x = 300;
	rand_sun_curr_y = 30;
	rand_sun_target_y = 200;
}

void update_rand_sun(BRAM_t* hdmi_ctrl){
	if(rand_sun_present){
		clear_sun(rand_sun_pos_x, rand_sun_curr_y, hdmi_ctrl);
		if(rand_sun_curr_y < rand_sun_target_y){
			rand_sun_curr_y += RAND_SUN_STEP;
		}else{
			rand_sun_curr_y = rand_sun_target_y;
		}
		draw_sun(rand_sun_pos_x, rand_sun_curr_y, hdmi_ctrl);
		rand_sun_appear_time = game_get_time_ms();
	}else{
		if(game_get_time_ms() - rand_sun_appear_time > 25000){
			generate_rand_sun();
			draw_sun(rand_sun_pos_x, rand_sun_curr_y, hdmi_ctrl);
		}
	}
}
